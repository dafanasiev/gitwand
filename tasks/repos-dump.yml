---
- name: dump all Github repos
  # Include here as many items as you expect to be pages of repos.
  # Sorry, I did not manage to invent any less ugly method.
  # At the time of this writing there are 374 repos.
  loop: "{{ github_pages }}"
  loop_control:
    loop_var: page
  uri:
    url: '{{ github_api }}/orgs/{{ github_org }}/repos?per_page={{ github_per_page }}&page={{ page }}'
    user: "{{ github_user }}"
    password: "{{ github_token }}"
    force_basic_auth: yes
  register: response
  # Do the next loop iteration with the very first page (when the response does not exist yet) or if
  # the last response returned anything.  If the last response was empty, than it's time to finish the loop.
  when: page == 1 or response.json | length > 0

- name: "Dump all the {{ response | json_query('results[*].json[*]') | flatten | length }} repos"
  loop: "{{ response | json_query('results[*].json[*]') | flatten }}"
  loop_control:
    loop_var: repo
  include_tasks: repo-dump.yml
